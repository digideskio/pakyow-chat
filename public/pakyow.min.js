var pw={};(function(){(function(){var root=this;var previousUnderscore=root._;var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.7.0";var createCallback=function(func,context,argCount){if(context===void 0)return func;switch(argCount==null?3:argCount){case 1:return function(value){return func.call(context,value)};case 2:return function(value,other){return func.call(context,value,other)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}};_.iteratee=function(value,context,argCount){if(value==null)return _.identity;if(_.isFunction(value))return createCallback(value,context,argCount);if(_.isObject(value))return _.matches(value);return _.property(value)};_.each=_.forEach=function(obj,iteratee,context){if(obj==null)return obj;iteratee=createCallback(iteratee,context);var i,length=obj.length;if(length===+length){for(i=0;i<length;i++){iteratee(obj[i],i,obj)}}else{var keys=_.keys(obj);for(i=0,length=keys.length;i<length;i++){iteratee(obj[keys[i]],keys[i],obj)}}return obj};_.map=_.collect=function(obj,iteratee,context){if(obj==null)return[];iteratee=_.iteratee(iteratee,context);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,results=Array(length),currentKey;for(var index=0;index<length;index++){currentKey=keys?keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iteratee,memo,context){if(obj==null)obj=[];iteratee=createCallback(iteratee,context,4);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,index=0,currentKey;if(arguments.length<3){if(!length)throw new TypeError(reduceError);memo=obj[keys?keys[index++]:index++]}for(;index<length;index++){currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};_.reduceRight=_.foldr=function(obj,iteratee,memo,context){if(obj==null)obj=[];iteratee=createCallback(iteratee,context,4);var keys=obj.length!==+obj.length&&_.keys(obj),index=(keys||obj).length,currentKey;if(arguments.length<3){if(!index)throw new TypeError(reduceError);memo=obj[keys?keys[--index]:--index]}while(index--){currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};_.find=_.detect=function(obj,predicate,context){var result;predicate=_.iteratee(predicate,context);_.some(obj,function(value,index,list){if(predicate(value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,predicate,context){var results=[];if(obj==null)return results;predicate=_.iteratee(predicate,context);_.each(obj,function(value,index,list){if(predicate(value,index,list))results.push(value)});return results};_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(_.iteratee(predicate)),context)};_.every=_.all=function(obj,predicate,context){if(obj==null)return true;predicate=_.iteratee(predicate,context);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,index,currentKey;for(index=0;index<length;index++){currentKey=keys?keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return false}return true};_.some=_.any=function(obj,predicate,context){if(obj==null)return false;predicate=_.iteratee(predicate,context);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,index,currentKey;for(index=0;index<length;index++){currentKey=keys?keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return true}return false};_.contains=_.include=function(obj,target){if(obj==null)return false;if(obj.length!==+obj.length)obj=_.values(obj);return _.indexOf(obj,target)>=0};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,_.property(key))};_.where=function(obj,attrs){return _.filter(obj,_.matches(attrs))};_.findWhere=function(obj,attrs){return _.find(obj,_.matches(attrs))};_.max=function(obj,iteratee,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(iteratee==null&&obj!=null){obj=obj.length===+obj.length?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value>result){result=value}}}else{iteratee=_.iteratee(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=value;lastComputed=computed}})}return result};_.min=function(obj,iteratee,context){var result=Infinity,lastComputed=Infinity,value,computed;if(iteratee==null&&obj!=null){obj=obj.length===+obj.length?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value<result){result=value}}}else{iteratee=_.iteratee(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed<lastComputed||computed===Infinity&&result===Infinity){result=value;lastComputed=computed}})}return result};_.shuffle=function(obj){var set=obj&&obj.length===+obj.length?obj:_.values(obj);var length=set.length;var shuffled=Array(length);for(var index=0,rand;index<length;index++){rand=_.random(0,index);if(rand!==index)shuffled[index]=shuffled[rand];shuffled[rand]=set[index]}return shuffled};_.sample=function(obj,n,guard){if(n==null||guard){if(obj.length!==+obj.length)obj=_.values(obj);return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};_.sortBy=function(obj,iteratee,context){iteratee=_.iteratee(iteratee,context);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iteratee(value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iteratee,context){var result={};iteratee=_.iteratee(iteratee,context);_.each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)});return result}};_.groupBy=group(function(result,value,key){if(_.has(result,key))result[key].push(value);else result[key]=[value]});_.indexBy=group(function(result,value,key){result[key]=value});_.countBy=group(function(result,value,key){if(_.has(result,key))result[key]++;else result[key]=1});_.sortedIndex=function(array,obj,iteratee,context){iteratee=_.iteratee(iteratee,context,1);var value=iteratee(obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;if(iteratee(array[mid])<value)low=mid+1;else high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.partition=function(obj,predicate,context){predicate=_.iteratee(predicate,context);var pass=[],fail=[];_.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)});return[pass,fail]};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[0];if(n<0)return[];return slice.call(array,0,n)};_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[array.length-1];return slice.call(array,Math.max(array.length-n,0))};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,output){if(shallow&&_.every(input,_.isArray)){return concat.apply(output,input)}for(var i=0,length=input.length;i<length;i++){var value=input[i];if(!_.isArray(value)&&!_.isArguments(value)){if(!strict)output.push(value)}else if(shallow){push.apply(output,value)}else{flatten(value,shallow,strict,output)}}return output};_.flatten=function(array,shallow){return flatten(array,shallow,false,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iteratee,context){if(array==null)return[];if(!_.isBoolean(isSorted)){context=iteratee;iteratee=isSorted;isSorted=false}if(iteratee!=null)iteratee=_.iteratee(iteratee,context);var result=[];var seen=[];for(var i=0,length=array.length;i<length;i++){var value=array[i];if(isSorted){if(!i||seen!==value)result.push(value);seen=value}else if(iteratee){var computed=iteratee(value,i,array);if(_.indexOf(seen,computed)<0){seen.push(computed);result.push(value)}}else if(_.indexOf(result,value)<0){result.push(value)}}return result};_.union=function(){return _.uniq(flatten(arguments,true,true,[]))};_.intersection=function(array){if(array==null)return[];var result=[];var argsLength=arguments.length;for(var i=0,length=array.length;i<length;i++){var item=array[i];if(_.contains(result,item))continue;for(var j=1;j<argsLength;j++){if(!_.contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result};_.difference=function(array){var rest=flatten(slice.call(arguments,1),true,true,[]);return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(array){if(array==null)return[];var length=_.max(arguments,"length").length;var results=Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(arguments,i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,length=list.length;i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,length=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,length+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}for(;i<length;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var idx=array.length;if(typeof from=="number"){idx=from<0?idx+from+1:Math.min(idx,from+1)}while(--idx>=0)if(array[idx]===item)return idx;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=step||1;var length=Math.max(Math.ceil((stop-start)/step),0);var range=Array(length);for(var idx=0;idx<length;idx++,start+=step){range[idx]=start}return range};var Ctor=function(){};_.bind=function(func,context){var args,bound;if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");args=slice.call(arguments,2);bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));Ctor.prototype=func.prototype;var self=new Ctor;Ctor.prototype=null;var result=func.apply(self,args.concat(slice.call(arguments)));if(_.isObject(result))return result;return self};return bound};_.partial=function(func){var boundArgs=slice.call(arguments,1);return function(){var position=0;var args=boundArgs.slice();for(var i=0,length=args.length;i<length;i++){if(args[i]===_)args[i]=arguments[position++]}while(position<arguments.length)args.push(arguments[position++]);return func.apply(this,args)}};_.bindAll=function(obj){var i,length=arguments.length,key;if(length<=1)throw new Error("bindAll must be passed function names");for(i=1;i<length;i++){key=arguments[i];obj[key]=_.bind(obj[key],obj)}return obj};_.memoize=function(func,hasher){var memoize=function(key){var cache=memoize.cache;var address=hasher?hasher.apply(this,arguments):key;if(!_.has(cache,address))cache[address]=func.apply(this,arguments);return cache[address]};memoize.cache={};return memoize};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;if(!options)options={};var later=function(){previous=options.leading===false?0:_.now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};return function(){var now=_.now();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;var later=function(){var last=_.now()-timestamp;if(last<wait&&last>0){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);if(!timeout)context=args=null}}};return function(){context=this;args=arguments;timestamp=_.now();var callNow=immediate&&!timeout;if(!timeout)timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args);context=args=null}return result}};_.wrap=function(func,wrapper){return _.partial(wrapper,func)};_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}};_.compose=function(){var args=arguments;var start=args.length-1;return function(){var i=start;var result=args[start].apply(this,arguments);while(i--)result=args[i].call(this,result);return result}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.before=function(times,func){var memo;return function(){if(--times>0){memo=func.apply(this,arguments)}else{func=null}return memo}};_.once=_.partial(_.before,2);_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){if(!_.isObject(obj))return obj;var source,prop;for(var i=1,length=arguments.length;i<length;i++){source=arguments[i];for(prop in source){if(hasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj};_.pick=function(obj,iteratee,context){var result={},key;if(obj==null)return result;if(_.isFunction(iteratee)){iteratee=createCallback(iteratee,context);for(key in obj){var value=obj[key];if(iteratee(value,key,obj))result[key]=value}}else{var keys=concat.apply([],slice.call(arguments,1));obj=new Object(obj);for(var i=0,length=keys.length;i<length;i++){key=keys[i];if(key in obj)result[key]=obj[key]}}return result};_.omit=function(obj,iteratee,context){if(_.isFunction(iteratee)){iteratee=_.negate(iteratee)}else{var keys=_.map(concat.apply([],slice.call(arguments,1)),String);iteratee=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iteratee,context)};_.defaults=function(obj){if(!_.isObject(obj))return obj;for(var i=1,length=arguments.length;i<length;i++){var source=arguments[i];for(var prop in source){if(obj[prop]===void 0)obj[prop]=source[prop]}}return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a===1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!==toString.call(b))return false;switch(className){case"[object RegExp]":case"[object String]":return""+a===""+b;case"[object Number]":if(+a!==+a)return+b!==+b;return+a===0?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]===a)return bStack[length]===b}var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&"constructor"in a&&"constructor"in b&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}aStack.push(a);bStack.push(b);var size,result;if(className==="[object Array]"){size=a.length;result=size===b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{var keys=_.keys(a),key;size=keys.length;result=_.keys(b).length===size;if(result){while(size--){key=keys[size];if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj)||_.isArguments(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)==="[object Array]"};_.isObject=function(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj};_.each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)==="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return _.has(obj,"callee")}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj=="function"||false}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!==+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)==="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.constant=function(value){return function(){return value}};_.noop=function(){};_.property=function(key){return function(obj){return obj[key]}};_.matches=function(attrs){var pairs=_.pairs(attrs),length=pairs.length;return function(obj){if(obj==null)return!length;obj=new Object(obj);for(var i=0;i<length;i++){var pair=pairs[i],key=pair[0];if(pair[1]!==obj[key]||!(key in obj))return false}return true}};_.times=function(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=createCallback(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};_.now=Date.now||function(){return(new Date).getTime()};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var unescapeMap=_.invert(escapeMap);var createEscaper=function(map){var escaper=function(match){return map[match]};var source="(?:"+_.keys(map).join("|")+")";var testRegexp=RegExp(source);var replaceRegexp=RegExp(source,"g");return function(string){string=string==null?"":""+string;return testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}};_.escape=createEscaper(escapeMap);_.unescape=createEscaper(unescapeMap);_.result=function(object,property){if(object==null)return void 0;var value=object[property];return _.isFunction(value)?object[property]():value};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\u2028|\u2029/g;var escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,settings,oldSettings){if(!settings&&oldSettings)settings=oldSettings;settings=_.defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,escapeChar);index=offset+match.length;if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}var template=function(data){return render.call(this,data,_)};var argument=settings.variable||"obj";template.source="function("+argument+"){\n"+source+"}";return template};_.chain=function(obj){var instance=_(obj);instance._chain=true;return instance};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};_.mixin(_);_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name==="shift"||name==="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.prototype.value=function(){return this._wrapped};if(typeof define==="function"&&define.amd){define("underscore",[],function(){return _})}}).call(this);pw.attrs={};pw.attrs.init=function(view_or_views){var views;if(view_or_views instanceof pw_View){views=[view_or_views]}else{views=view_or_views}return new pw_Attrs(views)};var pw_Attrs=function(views){this.views=views};pw_Attrs.prototype.style=function(value){_.each(this.views,function(view){pw.view.setAttr(view.node,"style",value)})};pw.state={};pw.state.guid=function(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return function(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}}();pw.state.build=function(sigArr,parentObj){var retState=[];for(var i=0;i<sigArr.length;i++){var elemState=pw.state.buildForElem(sigArr[i],parentObj);if(!elemState)continue;retState.push(elemState)}return retState};pw.state.buildForElem=function(sigTuple,parentObj){var sig=sigTuple[0];var obj={};if(sig.type==="scope"){obj.scope=sig.dom.getAttribute("data-scope");obj.id=sig.dom.getAttribute("data-id")}else if(sig.type==="prop"&&parentObj){parentObj[sig.dom.getAttribute("data-prop")]=pw.view.value(sig.dom);return}return[obj,pw.state.build(sigTuple[1],obj)]};pw.state.init=function(elem){return new pw_State(elem)};var pw_State=function(elem){this.initial=pw.state.build(pw.view.significant(elem));this.current=JSON.parse(JSON.stringify(this.initial));this.diffs=[]};pw_State.prototype.diff=function(elem){return _.map(_.flatten(pw.state.build(pw.view.significant(pw.view.scope(elem)))),function(elemState){var last=this.elem(elemState);var diffObj={elem:elem,guid:pw.state.guid(),scope:elemState.scope,id:elemState.id};for(var key in elemState){if(!last||elemState[key]!==last[key]){diffObj[key]=elemState[key]}}this.diffs.push(diffObj);return diffObj},this)};pw_State.prototype.update=function(diff,state){_.each(_.filter(_.flatten(state||this.current),function(s){return s.scope===diff.scope&&s.id===diff.id}),function(s){for(var key in diff){if(key==="guid")continue;if(s[key]!==diff[key]){s[key]=diff[key]}}})};pw_State.prototype.revert=function(){var diff=this.initial[0][0];this.diffs.push(diff);this.update(diff)};pw_State.prototype.rollback=function(guid){_.each(this.diffs,function(diff,i){if(diff.guid===guid){var rbState=JSON.parse(JSON.stringify(this.initial));_.each(this.diffs,function(aDiff){if(diff.guid===aDiff.guid){return}this.update(aDiff,rbState)},this);_.each(_.rest(this.diffs,i+1),function(aDiff){this.update(aDiff,rbState)},this);this.diffs.splice(i,1);this.current=rbState;return}},this)};pw_State.prototype.elem=function(elemState){return _.filter(_.flatten(this.current),function(s){return s.scope===elemState.scope&&s.id===elemState.id})[0]};pw.view={};pw.view.value=function(elem){if(elem.tagName==="INPUT"){if(elem.type==="checkbox"){if(elem.checked){return elem.name?elem.name:true}else{return false}}return elem.value}else if(elem.tagName==="TEXTAREA"){return elem.value}return elem.textContent.trim()};pw.view.significant=function(dom,arr){if(dom===document)dom=document.getElementsByTagName("body")[0];if(arr===undefined)arr=[];var sigInfo,sigObj,sigArr,nextArr;if(sigInfo=pw.view.isSignificant(dom)){sigObj={dom:sigInfo[0],type:sigInfo[1]};sigArr=[sigObj,[]];arr.push(sigArr);nextArr=sigArr[1]}else{nextArr=arr}var children=dom.children;for(var i=0;i<children.length;i++){pw.view.significant(children[i],nextArr)}return arr};var sigAttrs=["data-scope","data-prop"];pw.view.isSignificant=function(dom){var attr;for(var i=0;i<sigAttrs.length;i++){attr=sigAttrs[i];if(dom.hasAttribute(attr)){return[dom,attr.split("-")[1]]}}return false};pw.view.mutable=function(dom){return _.chain(pw.view.significant(dom)).flatten().filter(function(node){return pw.view.isMutable(node.dom)}).map(function(node){return node.dom})};pw.view.isMutable=function(dom){if(dom.tagName==="FORM"){return true}if(dom.tagName==="INPUT"&&!dom.disabled){return true}return false};pw.view.trigger=function(evtName,elem,data){var evt=document.createEvent("Event");evt.initEvent(evtName,true,true);elem._evtData=data;elem.dispatchEvent(evt)};pw.view.replaceEventListener=function(evtName,elem,cb){elem.removeEventListener(evtName);elem.addEventListener(evtName,cb)};pw.view.scope=function(elem){if(elem.getAttribute("data-scope")){return elem}return pw.view.scope(elem.parentNode)};pw.view.scopeName=function(elem){if(elem.getAttribute("data-scope")){return elem.getAttribute("data-scope")}return pw.view.scopeName(elem.parentNode)};pw.view.prop=function(elem){if(elem.getAttribute("data-prop")){return elem}return pw.view.prop(elem.parentNode)};pw.view.propName=function(elem){if(elem.getAttribute("data-prop")){return elem.getAttribute("data-prop")}return pw.view.propName(elem.parentNode)};pw.view.with=function(elem,cb){cb.call(elem)};pw.view.for=function(elem,data,cb){if(!(elem instanceof Array)&&!pw.view.isNodeList(elem))elem=[elem];if(!(data instanceof Array))data=[data];_.each(elem,function(e,i){cb.call(e,data[i])})};pw.view.match=function(elem,data){if(!(elem instanceof Array)&&!pw.view.isNodeList(elem))elem=[elem];if(!(data instanceof Array))data=[data];var collection=[];for(var i=0;i<data.length;i++){var view=elem[i];if(!view){view=_.last(elem)}var dup=view.cloneNode(true);view.parentNode.insertBefore(dup);collection.push(dup)}for(var i=0;i<elem.length;i++){elem[i].parentNode.removeChild(elem[i])}return collection};pw.view.repeat=function(elem,data,cb){pw.view.for(pw.view.match(elem,data),data,cb)};pw.view.bind=function(data,elem,cb){var bindings=pw.view.findBindings(elem);var scope=bindings[0];pw.view.for(elem,data,function(datum){if(!datum)return;if(datum.id)this.setAttribute("data-id",datum.id);pw.view.bindDataToScope(datum,scope,elem);if(!(typeof cb==="undefined"))cb.call(this,datum)})};pw.view.apply=function(data,elem,cb){var coll=pw.view.match(elem,data);pw.view.bind(data,coll,cb);return coll};pw.view.findBindings=function(elem){var bindings=[];pw.view.breadthFirst(elem,function(){var o=this;var scope=o.getAttribute("data-scope");if(!scope)return;var props=[];pw.view.breadthFirst(o,function(){var so=this;if(o!=so&&so.getAttribute("data-scope"))return;var prop=so.getAttribute("data-prop");if(!prop)return;props.push({prop:prop,doc:so})});bindings.push({scope:scope,doc:o,props:props})});return bindings};pw.view.bindDataToScope=function(data,scope,elem){if(!data)return;if(!scope)return;for(var i=0;i<scope["props"].length;i++){var p=scope["props"][i];k=p["prop"];v=data[k];if(!v){v=""}if(typeof v==="object"){pw.view.bindAttributesToDoc(v,p["doc"])}else{pw.view.bindValueToDoc(v,p["doc"])}}};pw.view.bindAttributesToDoc=function(attrs,doc){for(var attr in attrs){var value=attrs[attr];if(attr==="content"){pw.view.bindValueToDoc(value,doc);continue}if(_.isFunction(value))value=value.call(doc.getAttribute(attr));!value?pw.view.removeAttr(doc,attr):doc.setAttribute(attr,value)}};pw.view.bindValueToDoc=function(value,doc){if(pw.view.isTagWithoutValue(doc))return;if(doc.tagName==="INPUT"&&doc.type==="checkbox"){if(value===true||doc.value&&value===doc.value){doc.checked=true}else{doc.checked=false}}else{pw.view.isSelfClosingTag(doc)?doc.value=value:doc.textContent=value}};var valuelessTags=["SELECT"];pw.view.isTagWithoutValue=function(node){return valuelessTags.indexOf(node.tagName)!=-1?true:false};var selfClosingTags=["AREA","BASE","BASEFONT","BR","HR","INPUT","IMG","LINK","META"];pw.view.isSelfClosingTag=function(node){return selfClosingTags.indexOf(node.tagName)!=-1?true:false};pw.view.breadthFirst=function(elem,cb){var queue=[elem];while(queue.length>0){var node=queue.shift();if(typeof node=="object"&&"nodeType"in node&&node.nodeType===1&&node.cloneNode){cb.call(node)}var children=node.childNodes;if(children){for(var i=0;i<children.length;i++){queue.push(children[i])}}}};pw.view.isNodeList=function(nodes){return typeof nodes.length!=="undefined"};pw.view.byAttr=function(node,attr,compareValue){var arr=[];var os=pw.view.all(node);for(var i=0;i<os.length;i++){var o=os[i];var value=o.getAttribute(attr);if(value!==null&&(typeof compareValue==="undefined"||value==compareValue)){arr.push(o)}}return arr};pw.view.setAttr=function(node,attr,value){node.setAttribute(attr,_.map(_.pairs(value),function(pair){return pair[0]+":"+pair[1]}).join(";"))};pw.view.removeAttr=function(node,attr){node.removeAttribute(attr)};pw.view.all=function(node){var arr=[];if(document!==node)arr.push(node);var os=node.getElementsByTagName("*");for(var i=0;i<os.length;i++){arr.push(os[i])}return arr};pw.view.clone=function(node){return node.cloneNode(true)};pw.view.before=function(node,newNode){node.parentNode.insertBefore(newNode,node)};pw.view.after=function(node,newNode){node.parentNode.insertBefore(newNode,this.nextSibling)};pw.view.remove=function(node){node.parentNode.removeChild(node)};pw.view.init=function(elem){return new pw_View(elem)};var pw_View=function(elem){this.node=elem};pw_View.prototype.applyState=function(stateArr,nodes){if(!nodes){nodes=pw.view.significant(this.node)}_.each(stateArr,function(state,i){var node=nodes[i];pw.view.bind(state[0],node[0].dom);this.applyState(state[1],node[1])
},this)};pw_View.prototype.clone=function(){return pw.view.init(pw.view.clone(this.node))};pw_View.prototype.remove=function(){pw.view.remove(this.node)};pw_View.prototype.bind=function(data){pw.view.bind(data,this.node)};pw_View.prototype.attrs=function(){return pw.attrs.init(this)};pw_View.prototype.prop=function(name){return _.map(pw.view.byAttr(this.node,"data-prop",name),function(node){return pw.view.init(node)})};pw_View.prototype.text=function(value){this.node.innerText=value};pw.collection={};pw.collection.init=function(views,selector){return new pw_Collection(views,selector)};pw.collection.fromNodes=function(nodes,selector){return pw.collection.init(_.map(nodes,function(node){return pw.view.init(node)}),selector)};var pw_Collection=function(views,selector){this.views=views;this.selector=selector};pw_Collection.prototype.find=function(query){var localSelector=this.selector;_.each(_.pairs(query),function(pair){localSelector+="[data-"+pair[0]+'="'+pair[1]+'"]'});return pw.collection.fromNodes(document.querySelectorAll(localSelector),localSelector)};pw_Collection.prototype.append=function(data){var last=this.views[this.views.length-1];this.views.push(last.append(data));return last};pw_Collection.prototype.prepend=function(data){var firstView=this.views[0];var prependedViews=_.map(data,function(datum){var view=firstView.prepend(datum);this.views.push(view);return view},this);return pw.collection.init(prependedViews)};pw_Collection.prototype.remove=function(){_.each(this.views,function(view){view.remove()})};pw_Collection.prototype.removeView=function(view){view.remove();this.views=_.without(this.views,_.findWhere(this.views,view))};pw_Collection.prototype.addView=function(view){var lastView=this.views[this.views.length-1];pw.view.after(lastView.node,view.node);this.views.push(view)};pw_Collection.prototype.for=function(data,fn){if(!(data instanceof Array))data=[data];_.each(this.views,function(view,i){fn.call(view,data[i])})};pw_Collection.prototype.match=function(data,fn){if(!(data instanceof Array))data=[data];if(data.length===0){this.remove();return fn.call(this)}else{_.each(this.views,function(view){var id=parseInt(view.node.getAttribute("data-id"));if(!id)return;if(!_.find(data,function(datum){return datum.id===id})){this.removeView(view)}},this);if(data.length>this.views.length){var channel=this.views[0].node.getAttribute("data-channel");var that=this;window.socket.send({action:"fetch-view",channel:channel,uri:window.location.pathname+window.location.search},function(res){var e=document.createElement("div");e.innerHTML=res.body;var blankView=pw.view.init(e.childNodes[0]);blankView.node.removeAttribute("data-id");_.each(data,function(datum){if(!_.find(that.views,function(view){return parseInt(view.node.getAttribute("data-id"))===datum.id})){that.addView(blankView.clone())}},that);return fn.call(that)})}else{return fn.call(this)}}return this};pw_Collection.prototype.repeat=function(data,fn){this.match(data,function(){this.for(data,fn)})};pw_Collection.prototype.bind=function(data,fn){this.for(data,function(datum){this.bind(datum);if(!(typeof fn==="undefined"))fn.call(this,datum)});return this};pw_Collection.prototype.apply=function(data,fn){this.match(data,function(){this.bind(data,fn);this.order(_.map(data,function(datum){return datum.id}))})};pw_Collection.prototype.attrs=function(){return pw.attrs.init(this.views)};pw_Collection.prototype.order=function(orderedIds){_.each(orderedIds,function(id){var match=_.find(this.views,function(view){return parseInt(view.node.getAttribute("data-id"))===id});match.node.parentNode.appendChild(match.node)},this)};pw_Collection.prototype.prop=function(name){var propViews=[];_.each(this.views,function(view){propViews=propViews.concat(view.prop(name))});return pw.collection.init(propViews)};pw_Collection.prototype.length=function(){return this.views.length};pw.component={};pw.component.init=function(){return new pw_Component};var components={};var channelComponents={};pw.component.resetChannels=function(){channelComponents={}};pw.component.findAndInit=function(node){pw.component.resetChannels();_.each(pw.view.byAttr(node,"data-ui"),function(uiNode){var name=uiNode.getAttribute("data-ui");var cfn=components[name];if(cfn){var channel=uiNode.getAttribute("data-channel");var config=uiNode.getAttribute("data-config");var view=pw.view.init(uiNode);var component=new cfn(view,pw.component.buildConfigObject(config));component.config=config;component.view=view;pw.component.registerForChannel(component,channel)}else{console.log("component not found: "+name)}})};pw.component.push=function(packet){_.each(channelComponents[packet.channel],function(component){component.message(packet.channel,packet.payload)})};pw.component.register=function(name,fn){fn.prototype.listen=function(channel){pw.component.registerForChannel(this,channel)};fn.prototype.broadcast=function(payload,channel){pw.component.push({payload:payload,channel:channel})};components[name]=fn};pw.component.buildConfigObject=function(configString){var confObj={};if(configString!=null){var pairs=configString.split(";");for(var i=0;i<pairs.length;i++){var kv=pairs[i].trim().split(":");confObj[kv[0].trim()]=kv[1].trim()}}return confObj};pw.component.registerForChannel=function(component,channel){if(!channelComponents[channel]){channelComponents[channel]=[]}channelComponents[channel].push(component)};var pw_Component=function(cfn,node){};document.addEventListener("DOMContentLoaded",function(event){pw.component.findAndInit(document.querySelectorAll("body")[0])});pw.endpoint={};pw.endpoint.providers={prop:[],scope:[],component:[]};pw.endpoint.subscribers={};pw.endpoint.provider=function(type,provider){if(!_.contains(pw.endpoint.providers["type"],provider)){if(provider.tagName==="INPUT"){if(provider.type==="checkbox"){provider.addEventListener("change",pw.endpoint.mutate)}}pw.endpoint.providers[type].push(provider);pw.endpoint.subscribers[provider]=[]}};pw.endpoint.subscribe=function(provider,cb,ctx){pw.endpoint.subscribers[provider].push([cb,ctx])};pw.endpoint.mutate=function(evt){_.each(pw.endpoint.subscribers[evt.target],function(cb){cb[0].call(cb[1],evt.target)})};var pw_Endpoint=function(){};pw.socket={};pw.socket.init=function(options){return pw.socket.connect(options.host,options.port,options.protocol,options.connId,options.cb)};pw.socket.connect=function(host,port,protocol,connId,cb){if(typeof host==="undefined")host=window.location.hostname;if(typeof port==="undefined")port=window.location.port;if(typeof protocol==="undefined")protocol=window.location.protocol;if(typeof connId==="undefined")connId=document.getElementsByTagName("body")[0].getAttribute("data-socket-connection-id");var wsUrl="";if(protocol==="http:"){wsUrl+="ws://"}else if(protocol==="https:"){wsUrl+="wss://"}wsUrl+=host;if(port){wsUrl+=":"+port}wsUrl+="/?socket_connection_id="+connId;return new pw_Socket(wsUrl,cb)};var pw_Socket=function(url,cb){var self=this;this.callbacks={};this.url=url;this.initCb=cb;this.ws=new WebSocket(url);this.id=url.split("socket_connection_id=")[1];this.ws.onmessage=function(evt){var data=JSON.parse(evt.data);if(data.id){var cb=self.callbacks[data.id];if(cb){cb.call(this,data);return}}self.message(data)};this.ws.onclose=function(evt){console.log("socket closed");self.reconnect()};this.ws.onopen=function(evt){console.log("socket open");if(self.initCb){self.initCb(self)}}};pw_Socket.prototype.send=function(message,cb){message.id=pw.state.guid();if(!message.input){message.input={}}message.input.socket_connection_id=this.id;this.callbacks[message.id]=cb;this.ws.send(JSON.stringify(message))};pw_Socket.prototype.message=function(packet){console.log("received message");console.log(packet);var selector='*[data-channel="'+packet.channel+'"]';if(packet.channel.split(":")[0]==="component"){pw.component.push(packet);return}var nodes=document.querySelectorAll(selector);if(nodes.length===0){return}pw.instruct.process(pw.collection.fromNodes(nodes,selector),packet,this)};pw_Socket.prototype.reconnect=function(){var self=this;if(!self.socketWait){self.socketWait=100}else{self.socketWait*=1.25}console.log("reconnecting socket in "+self.socketWait+"ms");setTimeout(function(){pw.socket.init({cb:self.initCb})},self.socketWait)};document.addEventListener("DOMContentLoaded",function(event){pw.socket.init({cb:function(socket){window.socket=socket}})});pw.instruct={};pw.instruct.process=function(collection,packet,socket){if(collection.length()===1&&collection.views[0].node.getAttribute("data-version")==="empty"){pw.instruct.fetchView(packet,socket,collection.views[0].node)}else{pw.instruct.perform(collection,packet.payload)}};pw.instruct.fetchView=function(packet,socket,node){socket.send({action:"fetch-view",channel:packet.channel,uri:window.location.pathname+window.location.search},function(res){var e=document.createElement("div");e.innerHTML=res.body;var parent=node.parentNode;parent.replaceChild(e.childNodes[0],node);var selector='*[data-channel="'+packet.channel+'"]';var nodes=parent.querySelectorAll(selector);pw.instruct.perform(pw.collection.fromNodes(nodes,selector),packet.payload)})};pw.instruct.perform=function(collection,instructions){var self=this;_.each(instructions,function(instruction,i){var method=instruction[0];var value=instruction[1];var nested=instruction[2];if(collection[method]){if(method=="repeat"){collection[method].call(collection,value,function(datum){pw.instruct.perform(this,nested)});return}else{var mutatedViews=collection[method].call(collection,value)}}else{console.log("could not find method named: "+method);return}if(nested instanceof Array){pw.instruct.perform(mutatedViews,nested)}else if(mutatedViews){collection=mutatedViews}})};if(typeof define==="function"&&define.amd){define(pw)}else if(typeof module==="object"&&module.exports){module.exports=pw}else{this.pw=pw}})();pw.component.register("fastlink",function(view,config){var that=this;if(window.history){view.node.addEventListener("click",function(evt){evt.preventDefault();window.history.pushState({uri:this.href},this.href,this.href);return false})}else{}});pw.component.register("mutable",function(view,config){var that=this;this.mutate=function(target){_.each(this.state.diff(target),function(diff){delete diff.elem;var input={};var datum=_.clone(diff);delete datum.guid;delete datum.scope;delete datum.id;input[diff.scope]=datum;var message={action:"call_route",input:input};if(view.node.tagName==="FORM"){var method;var $methodOverride=view.node.querySelector('input[name="_method"]');if($methodOverride){method=$methodOverride.value}else{method=view.node.getAttribute("method")}message.method=method;message.uri=view.node.getAttribute("action")}else{}var self=this;window.socket.send(message,function(res){if(res.status===302&&res.headers.Location!==window.location.pathname){var dest=res.headers.Location;history.pushState({uri:dest},dest,dest);return}else if(res.status===400){}else{self.state.rollback(diff.guid)}pw.component.push({channel:"response:received",payload:{response:res}});self.state.revert();view.applyState(self.state.current)})},this)};var node=view.node;var self=this;var callback=function(evt){evt.preventDefault();self.mutate(evt.target)};this.state=pw.state.init(node);if(node.tagName==="FORM"){node.addEventListener("submit",callback)}if(node.tagName==="INPUT"){if(node.type==="checkbox"){node.addEventListener("change",callback)}}node._hasEventListener=true;node.addEventListener("mutate",callback)});pw.component.register("notifier",function(view,config){this.listen("notification:published");this.listen("response:received");view.node.addEventListener("click",function(evt){view.node.classList.add("hide")});this.message=function(channel,payload){if(channel==="response:received"){var notification=payload.response.headers["Pakyow-Notify"];if(notification){view.node.innerText=notification;view.node.classList.remove("hide")}}else if(channel==="notification:published"){view.node.innerText=payload.notification;view.node.classList.remove("hide")}}});(function(history){var originalUri=window.location.href;if(history){var pushState=history.pushState;history.pushState=function(state,title,uri){if(typeof history.onpushstate=="function"){history.onpushstate({state:state})}window.socket.send({uri:state.uri||state.url,action:"call_route",method:"get"},function(payload){var body=payload.body[0];if(body.match(/<title>/)){document.title=body.split(/<title>/)[1].split("</title>")[0]}if(body.match(/<body [^>]*>/)){document.body.innerHTML=body.split(/<body [^>]*>/)[1].split("</body>")[0]}else{document.body.innerHTML=body}pw.component.findAndInit(document.querySelectorAll("body")[0])});return pushState.apply(history,arguments)};window.onpopstate=function(evt){var state=evt.state;if(!state.uri){state.uri=originalUri}history.pushState(state,state.uri,state.uri)}}else{}})(window.history);